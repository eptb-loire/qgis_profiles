# yaml-language-server: $schema=https://raw.githubusercontent.com/Guts/qgis-deployment-cli/main/docs/schemas/scenario/schema.json

metadata:
  title: "Profile EP Loire"
  id: eploire_utilisateur
  description: >-
    Scénario de deploiement des profils utilisateurs, basés sur des secteurs géographiques.

settings:
  DEBUG: false
  LOCAL_WORK_DIR: ~/.cache/qgis-deployment-toolbelt/eploire/
  SCENARIO_VALIDATION: true

steps:
  - name: Find installed QGIS
    uses: qgis-installation-finder
    with:
      version_priority:
        - "3.34"
        - "3.28"
      if_not_found: error

  - name: Télécharge toutes les versions de tous les plugins listés dans tous les profils
    uses: qplugins-downloader
    with:
      force: true
      threads: 5

  - name: Synchronise les plugins téléchargés avec ceux installés dans les profils
    uses: qplugins-synchronizer
    with:
      action: create_or_restore
      source: ~/.cache/qgis-deployment-toolbelt/plugins  
  - name: Download profiles from remote Git server
    uses: qprofiles-downloader
    with:
      branch: main
      protocol: git_remote
      source: https://github.com/eptb-loire/qgis_profiles.git

  - name: Synchronize installed profiles from downloaded ones
    uses: qprofiles-synchronizer
    with:
      sync_mode: only_different_version

  - name: Créer des raccourcis pour les profils
    uses: shortcuts-manager
    with:
      action: create_or_restore
      include:
        - profile: axe_loire
          label: "Qgis Axe Loire"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"
        - profile: cher
          label: "Qgis Bassin du Cher"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"
        - profile: haut_bassin
          label: "Qgis Allier et Loire amont"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"
        - profile: loire_aval
          label: "Qgis Loire aval"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"
        - profile: maine
          label: "Qgis Bassin de la Maine"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"
        - profile: support
          label: "Qgis essentiel BV Loire"
          additional_arguments: "--noversioncheck"
          desktop: true
          start_menu: true
          icon: "qgis_icone_eploire.ico"

  - name: Installe les écrans de démarrage de QGIS (splash screens) par profil
    uses: splash-screen-manager
    with:
      action: create_or_restore
      strict: false


